/*********************************************************
  نام فایل: 01-Database-Design.md
  مسیر: docs/smart-docs/06-Database/01-Database-Design.md
*********************************************************/
/* به نام خدای نزدیک */

# طراحی پایگاه داده (Database Design)

این مستند ساختار جداول و فیلدهای پایگاه داده پروژه را توضیح می‌دهد.

## 1. مقدمه
پایگاه داده این پروژه بر اساس SQLite طراحی شده و شامل جداول مختلف برای مدیریت کاربران، تسک‌ها و سایر موجودیت‌های سیستم است.

## 2. موجودیت‌های اصلی

### 2.1. جدول `users` (کاربران)
این جدول برای ذخیره اطلاعات کاربران استفاده می‌شود.

| فیلد         | نوع         | توضیحات                         |
|-------------|-------------|----------------------------------|
| id          | STRING      | شناسه یکتا، کلید اصلی            |
| username    | STRING      | نام کاربری، منحصر به فرد         |
| password    | STRING      | رمز عبور هش‌شده با bcrypt        |
| full_name   | STRING      | نام کامل کاربر                   |
| email       | STRING      | ایمیل کاربر، منحصر به فرد        |
| mobile      | STRING      | شماره موبایل (قابل خالی بودن)    |
| role        | STRING      | نقش کاربر (admin, user, etc.)    |
| avatar      | STRING      | مسیر فایل تصویر کاربر (قابل خالی بودن) |
| is_active   | INTEGER     | وضعیت فعال بودن (1/0)            |
| created_at  | INTEGER     | زمان ایجاد (timestamp)           |
| updated_at  | INTEGER     | زمان به‌روزرسانی (timestamp)     |
| last_login  | INTEGER     | زمان آخرین ورود (timestamp)      |
| settings    | TEXT        | تنظیمات کاربر (JSON)             |

### 2.2. جدول `tasks` (تسک‌ها)
این جدول برای ذخیره اطلاعات تسک‌ها و فعالیت‌ها استفاده می‌شود.

| فیلد         | نوع         | توضیحات                         |
|-------------|-------------|----------------------------------|
| id          | STRING      | شناسه یکتا، کلید اصلی            |
| title       | STRING      | عنوان تسک                        |
| description | TEXT        | توضیحات تسک                      |
| type        | STRING      | نوع تسک (feature, bug, etc.)     |
| priority    | STRING      | اولویت (high, medium, low)       |
| status      | STRING      | وضعیت (todo, in-progress, done)  |
| creator_id  | STRING      | شناسه ایجادکننده (FK به users)   |
| assignee_id | STRING      | شناسه انجام‌دهنده (FK به users)  |
| parent_task_id | STRING   | شناسه تسک والد (برای subtasks)   |
| created_at  | INTEGER     | زمان ایجاد (timestamp)           |
| updated_at  | INTEGER     | زمان به‌روزرسانی (timestamp)     |
| due_date    | INTEGER     | زمان سررسید (timestamp)          |
| metadata    | TEXT        | اطلاعات اضافی (JSON)             |

### 2.3. جدول `tags` (تگ‌ها)
این جدول برای ذخیره تگ‌ها استفاده می‌شود.

| فیلد       | نوع         | توضیحات                         |
|------------|-------------|----------------------------------|
| id         | STRING      | شناسه یکتا، کلید اصلی            |
| name       | STRING      | نام تگ                           |
| created_at | INTEGER     | زمان ایجاد (timestamp)           |

### 2.4. جدول `task_tags` (رابطه بین تسک‌ها و تگ‌ها)
این جدول برای ایجاد رابطه چند به چند بین تسک‌ها و تگ‌ها استفاده می‌شود.

| فیلد        | نوع         | توضیحات                         |
|-------------|-------------|----------------------------------|
| task_id     | STRING      | شناسه تسک (FK به tasks)          |
| tag_id      | STRING      | شناسه تگ (FK به tags)            |

## 3. ارتباطات بین جداول

- هر کاربر (users) می‌تواند چندین تسک ایجاد کند (رابطه یک به چند با tasks).
- هر کاربر (users) می‌تواند چندین تسک به او محول شود (رابطه یک به چند با tasks).
- هر تسک (tasks) می‌تواند چندین تگ (tags) داشته باشد (رابطه چند به چند با tags از طریق task_tags).
- هر تسک (tasks) می‌تواند یک تسک والد داشته باشد (رابطه خود-ارجاعی).

## 4. نکات پیاده‌سازی

### 4.1. نوع داده‌ها
- برای شناسه‌ها از رشته‌های UUID یا nanoid استفاده می‌شود.
- برای زمان، از timestamp یونیکس استفاده می‌شود (ثانیه از اپوک).
- برای داده‌های JSON، از نوع TEXT استفاده می‌شود که بعداً پارس می‌شود.

### 4.2. ایندکس‌ها
- روی فیلدهای کلید خارجی (`creator_id`, `assignee_id`, etc.) ایندکس ایجاد می‌شود.
- روی فیلدهای پرکاربرد در جستجو (`title`, `status`, etc.) ایندکس ایجاد می‌شود.

### 4.3. محدودیت‌ها
- منحصر به فرد بودن `username` و `email` در جدول `users`.
- عدم حذف کاربران با استفاده از `is_active` به جای حذف فیزیکی.

## 5. مدیریت تغییرات ساختار
تغییرات ساختار پایگاه داده باید با احتیاط و با در نظر گرفتن موارد زیر انجام شود:
- هر تغییر ساختاری باید در فایل `setup.ts` در بخش مربوطه اعمال شود.
- تغییرات باید با همخوانی در کد برنامه انجام شود.
- در صورت نیاز به مهاجرت داده‌ها، باید اسکریپت مهاجرت نوشته شود.

---

## منابع و مراجع
- [SQLite Documentation](https://www.sqlite.org/docs.html)
- [Designing Data-Intensive Applications](https://dataintensive.net/)
- [Database Design Guide](https://www.ntu.edu.sg/home/ehchua/programming/sql/Relational_Database_Design.html) 